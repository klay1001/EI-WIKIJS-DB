---
title: W15-Use HANACleaner python script to clean up HANA backup files
description: 
published: true
date: 2022-12-30T09:10:07.361Z
tags: 
editor: markdown
dateCreated: 2022-12-30T09:07:07.487Z
---

## Use HANACleaner python script to clean up HANA backup files & Catalog
本文在描述一實作案例的設置方式。清理的動作是在 HANA PRD (node 1) 上以 linux cron 排程去設定的。執行身份是 HANA admin (hnpadm)。執行的 Python script 是取自 Note 2399996 – How-To: Configuring automatic SAP HANA Cleanup with SAP HANACleaner 。請先下載 notes 的附件並解開，取得  hanacleaner.py 檔。

首先把 hanacleaner.py 放到 prddb1 的 /usr/sap/HNP/HDB00 目錄，注意檔案權限要能被 hnpadm 執行。

![image001.png](/s2/w15/image001.png)
再來，該 script 會連到 HANA DB，所以用 hdbuserstore LIST 去看是否有現成的 connection 可以用。很幸運的有一個 KEY= PRDDB 的連線存在，且它是用 SYSTEM 帳號，應該有權限存取及修改 BACKUP CATALOG，就用它
![image002.png](/s2/w15/image002.png)
First Try: 先手動執行，如下圖，下 command

>python ./hanacleanerpy –k PRDDB –bd 70 –be 10 –bb true 

參數說明:
-k 是給 hdbuserstore 裡你要用的 Key
-bd 是指要清掉多久之前的 data & log backup，以天為單位
-be  是指至少要留多少筆 data or log backup entry 在 backup catalog 裡。也就是若備份很舊清掉後會沒有剩幾筆，那至少也要留下這個筆數。
-bb 是指(true 或  false) 是否要清掉對應的 backup files (data backup files 及 log backup files)，當然要給 true。

![image003.png](/s2/w15/image003.png)
結果看來沒有成功，錯誤是因為我給的 Key=PRDDB 的 ENV: prddb:30015 中的 hostname prddb 與本機 hostname prddb1 不同，所以不執行。經查可用一個參數 –vlh 讓 script 認得 virtual host name。
所以如下再重打 command:

>python ./hanacleaner.py –k PRDDB –vlh prddb –bd 70 –be 5  -bb true

![image004.png](/s2/w15/image004.png)
按 ENTER
![image005.png](/s2/w15/image005.png)
看來是 work 了。

為了確認是否真的成功，可以去看備出去的 log file 目錄，是否舊的 log 被清掉了。通常若上線後很久沒清，可能會累積到十幾萬甚至幾十萬個檔，連做個 ls 都等很久，此時要有耐心。上面的 script 雖然執行完回到 command prompt，但根據觀察, backup file 還在陸續 delete 中，沒有那麼快，要等一下。

後來，我把 hanacleaner.py 移到新目錄 /usr/sap/HNP/HDB00/HANACleaner 裡頭，並在同目錄寫了一個 bash 檔 hanacleaner.sh 

![image006.png](/s2/w15/image006.png)
hanacleaner.sh 內容 
![image007.png](/s2/w15/image007.png)
#!/bin/sh
source $HOME/.bashrc
python /usr/sap/HNP/HDB00/HANACleaner/hanacleaner.py –k PRDDB –vlh prddb –bd 31 –be 5 –bb true –op /tmp/hanacleaneroutput

然後用 crontab –e (以 hnpadm 身份執行) 去寫 crontab item  (會進入 vi 模式，請各位寫一下基本 vi 用法。若你卡在裡面出不來，請打 ESC 二次 ， 然後 :q! Enter 脫身)

crontab 寫好後可用 crontab –l 來看一下，如下圖。第一個 #30 02 * * *…cleanlogbackup.sh 那一行不用管，那是之前自己寫的，現在 comment 掉不用了。

![image008.png](/s2/w15/image008.png)
上圖中是說 每天凌晨 2:30 會執行 hanacleaner.sh 

OK, Let’s wait & see

